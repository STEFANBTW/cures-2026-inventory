let currentFilter='all';let currentSort='default';function renderSummary(items){const grid=document.getElementById('summaryGrid');const countEl=document.getElementById('count');const totalEl=document.getElementById('grand-total-display');const stickyTotalEl=document.getElementById('sticky-dynamic-price');const mobileDynamicEl=document.getElementById('mobile-dynamic-total');if(!grid)return;grid.innerHTML='';const fragment=document.createDocumentFragment();let grandTotal=0;items.forEach(item=>{const quantity=item.quantity||1;const unitBase=parsePrice(item.basePrice);const unitShip=parsePrice(item.shipping||0);const totalCost=(unitBase+unitShip)*quantity;grandTotal+=totalCost;let badgeHtml='';if(item.dealTag&&item.dealTag!=='None'){if(item.dealTag.startsWith('http')){badgeHtml=`<img src="${item.dealTag}"class="deal-badge-img"alt="Deal Badge">`;}else{let badgeClass='deal-official';if(item.dealTag==='Choice')badgeClass='deal-choice';else if(item.dealTag==='Jumia Express')badgeClass='deal-express';else if(item.dealTag==='SuperDeals')badgeClass='deal-super';badgeHtml=`<div class="deal-badge ${badgeClass}">${item.dealTag}</div>`;}}
let essentialHtml='';if(item.essentialRank===1){essentialHtml=`<div class="essential-badge">ESSENTIAL<span class="badge-rank-number">${item.essentialRank}</span></div>`;}else if(item.essentialRank>1){essentialHtml=`<div class="rank-badge">RANK<span class="badge-rank-number">${item.essentialRank}</span></div>`;}
const shippingHtml=unitShip===0?'<span class="free-ship-tag">Free Ship</span>':`<div class="shipping-info-container"><div class="shipping-label">Shipping</div><span class="shipping-info">${getFormattedPrice(unitShip)}</span></div>`;const imagesList=item.images&&item.images.length>0?item.images:["https://placehold.co/300x200?text=No+Img"];const thumbnailImagesList=imagesList.map(src=>{const lastDot=src.lastIndexOf('.');if(lastDot!==-1){return src.substring(0,lastDot)+'_thumb'+src.substring(lastDot);}
return src;});const sliderHTML=thumbnailImagesList.map(src=>`<img loading="lazy"decoding="async"src="${src}"alt="${item.name}">`).join('');const cardWrapper=document.createElement('div');cardWrapper.className='summary-card-wrapper';const card=document.createElement('div');card.className='summary-card'+(item.essentialRank===1?' essential':'');card.innerHTML=`<div class="card-image"><div class="slider-frame"><div class="slider-track">${sliderHTML}</div></div><div class="source-tag">${item.source}${badgeHtml}</div><div class="meta-row"><span class="card-category">${item.category}</span>${essentialHtml}</div></div><div class="card-body"><div class="card-inner-body"><div class="card-title"title="${item.name}">${item.nickname||item.name}</div><div class="card-quantity">Quantity:${quantity}</div><div class="card-footer">${quantity>1?(unitShip>0?`<div class="price-breakdown">(${getFormattedPrice(unitBase)}+${getFormattedPrice(unitShip)})&times;${quantity}</div>`:`<div class="price-breakdown">${getFormattedPrice(unitBase)}&times;${quantity}</div>`):(unitShip>0?`<div class="price-breakdown">${getFormattedPrice(unitBase)}+${getFormattedPrice(unitShip)}</div>`:'')}<div class="final-price-row"><div><div class="total-price-label">Total Price</div><span class="final-price">${getFormattedPrice(totalCost)}</span></div>${shippingHtml}</div></div><a href="${item.productLink || '#'}"target="_blank"class="sum-deets">Visit Store</a></div></div>`;card.addEventListener('click',(e)=>{if(e.target.closest('a')||e.target.closest('.sum-deets'))return;if(card.classList.contains('mobile-hover-state')){card.classList.remove('mobile-hover-state');}else{document.querySelectorAll('.summary-card.mobile-hover-state').forEach(c=>c.classList.remove('mobile-hover-state'));card.classList.add('mobile-hover-state');}});cardWrapper.appendChild(card);fragment.appendChild(cardWrapper);});grid.appendChild(fragment);countEl.textContent=items.length;const formattedTotal=getFormattedPrice(grandTotal);if(stickyTotalEl)stickyTotalEl.textContent=formattedTotal;if(mobileDynamicEl)mobileDynamicEl.textContent=formattedTotal;initSliders();}
function getFilteredAndSortedList(){let list=[...inventory];if(searchTerm){list=list.filter(item=>item.name.toLowerCase().includes(searchTerm));}
if(currentFilter!=='all'){if(currentFilter==='essential'){list=list.filter(i=>i.essentialRank===1);}else if(currentFilter==='freeShipping'){list=list.filter(i=>i.shipping===0);}else if(['AliExpress','Jumia','Temu','Local Retail'].includes(currentFilter)){list=list.filter(i=>i.source===currentFilter);}else{list=list.filter(i=>i.category===currentFilter);}}
const getTotalCost=item=>(parsePrice(item.basePrice)+parsePrice(item.shipping||0))*(item.quantity||1);if(currentSort==='price-asc'){list.sort((a,b)=>getTotalCost(a)-getTotalCost(b));}else if(currentSort==='price-desc'){list.sort((a,b)=>getTotalCost(b)-getTotalCost(a));}else if(currentSort==='essential'){list.sort((a,b)=>{if(a.isEssential&&!b.isEssential)return-1;if(!a.isEssential&&b.isEssential)return 1;return(a.essentialRank||99)-(b.essentialRank||99);});}
return list;}
function filterSummary(criteria,btnElement){currentFilter=criteria;if(btnElement){document.querySelectorAll('.filter-button').forEach(b=>b.classList.remove('active'));btnElement.classList.add('active');}
const listToRender=getFilteredAndSortedList();renderSummary(listToRender);const navbar=document.getElementById("navbar");const isFilterScroll=true;if(navbar)navbar.classList.add("nav-hidden");const utlBar=document.getElementById('stc');const grid=document.getElementById('summaryGrid');if(grid&&utlBar){const headerOffset=utlBar.offsetHeight;const elementPosition=grid.getBoundingClientRect().top;const offsetPosition=elementPosition+window.pageYOffset-headerOffset;window.scrollTo({top:offsetPosition,behavior:"smooth"});}}
function sortSummary(){const sortSelect=document.getElementById('sort-select');if(sortSelect){currentSort=sortSelect.value;}
const listToRender=getFilteredAndSortedList();renderSummary(listToRender);}
function initSliders(){if(window.sliderIntervals){window.sliderIntervals.forEach(clearInterval);}
window.sliderIntervals=[];const tracks=document.querySelectorAll('.slider-track');tracks.forEach(track=>{const images=track.querySelectorAll('img');if(images.length<=1)return;let currentIndex=0;const randomOffset=Math.floor(Math.random()*1000);setTimeout(()=>{const intervalId=setInterval(()=>{currentIndex++;if(currentIndex>=images.length){currentIndex=0;}
track.style.transform=`translateX(-${currentIndex*100}%)`;},3000);window.sliderIntervals.push(intervalId);},randomOffset);});}
document.addEventListener("DOMContentLoaded",function(){const cards=document.querySelectorAll('.summary-card-wrapper');const observerOptions={root:null,rootMargin:'0px',threshold:0.15};const observer=new IntersectionObserver((entries,observer)=>{entries.forEach((entry,index)=>{if(entry.isIntersecting){const delay=entry.target.dataset.delay||0;setTimeout(()=>{entry.target.classList.add('in-view');},delay);observer.unobserve(entry.target);}});},observerOptions);cards.forEach((card,index)=>{let staggerTime=(index%5)*100;card.dataset.delay=staggerTime;observer.observe(card);});});